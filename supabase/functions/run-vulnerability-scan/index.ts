/**
 * Edge Function (TypeScript/Deno) — NOT SQL. Do not run this file in the SQL Editor.
 * Deploy with: supabase functions deploy run-vulnerability-scan
 * Calls scanner URL, maps results to issues, inserts into vulnerability_scan_results.
 * Requires secrets: SCANNER_URL (e.g. https://your-scanner.railway.app/scan).
 */
// @ts-nocheck — This file runs in Deno (Supabase Edge Runtime); IDE uses Node/TS and doesn't understand Deno globals/imports.
import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.0";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

function normalizeSeverity(s: string): "low" | "medium" | "high" {
  const t = String(s).toLowerCase();
  if (t === "critical" || t === "high") return "high";
  if (t === "medium") return "medium";
  return "low";
}

function mapScanToIssues(scan: {
  targets?: Array<{ target?: string; vulnerabilities?: Array<Record<string, unknown>> }>;
}): { issues: Array<{ id: string; title: string; detail: string; severity: string }>; target: string; summary: Record<string, unknown> } {
  const issues: Array<{ id: string; title: string; detail: string; severity: string }> = [];
  const targets = scan.targets || [];
  let targetLabel = "scan";
  for (const t of targets) {
    const tgt = t.target || "unknown";
    targetLabel = tgt;
    for (const v of t.vulnerabilities || []) {
      const id = (v.id ?? v.cve_id ?? "unknown") as string;
      const title = (v.title ?? "Vulnerability") as string;
      const desc = (v.description ?? v.evidence ?? "") as string;
      const detail = tgt ? `[${tgt}] ${desc}`.trim() : desc;
      const severity = normalizeSeverity((v.severity as string) ?? "low");
      issues.push({ id: String(id).replace(/\s/g, "-"), title: String(title).slice(0, 200), detail: String(detail).slice(0, 1000), severity });
    }
  }
  const summary = (scan as { statistics?: Record<string, unknown> }).statistics
    ? { ...(scan as { statistics: Record<string, unknown> }).statistics, issues_count: issues.length }
    : { issues_count: issues.length };
  return { issues, target: targetLabel, summary };
}

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response("ok", { headers: corsHeaders });
  }

  try {
    console.log("run-vulnerability-scan: start");
    const scannerUrl = Deno.env.get("SCANNER_URL");
    if (!scannerUrl) {
      console.log("run-vulnerability-scan: SCANNER_URL missing");
      return new Response(
        JSON.stringify({ error: "SCANNER_URL not configured. Set it in Edge Function secrets." }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    let body: { target?: string } = {};
    try {
      body = (await req.json()) as { target?: string };
    } catch {
      // no body
    }
    const target = body?.target || "127.0.0.1";

    console.log("run-vulnerability-scan: calling scanner", scannerUrl);
    const scanRes = await fetch(scannerUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "ngrok-skip-browser-warning": "true",
      },
      body: JSON.stringify({ target, quick: true }),
    });
    console.log("run-vulnerability-scan: scanner status", scanRes.status);
    if (!scanRes.ok) {
      const text = await scanRes.text();
      console.log("run-vulnerability-scan: scanner error body", text.slice(0, 200));
      return new Response(
        JSON.stringify({ error: `Scanner request failed: ${scanRes.status}`, detail: text.slice(0, 500) }),
        { status: 502, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    let scan: { targets?: unknown[]; statistics?: unknown };
    try {
      scan = (await scanRes.json()) as { targets?: unknown[]; statistics?: unknown };
    } catch {
      const text = await scanRes.text();
      return new Response(
        JSON.stringify({
          error: "Scanner did not return valid JSON. If using ngrok, ensure ngrok-skip-browser-warning header is sent.",
          detail: text.slice(0, 300),
        }),
        { status: 502, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }
    const { issues, target: targetLabel, summary } = mapScanToIssues(
      scan as { targets?: Array<{ target?: string; vulnerabilities?: Array<Record<string, unknown>> }> }
    );
    console.log("run-vulnerability-scan: issues count", issues.length);

    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const serviceRoleKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, serviceRoleKey);

    const { error } = await supabase.from("vulnerability_scan_results").insert({
      target: targetLabel,
      issues,
      summary,
    });
    if (error) {
      console.log("run-vulnerability-scan: insert error", error.message);
      return new Response(
        JSON.stringify({ error: "Failed to save scan results", detail: error.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log("run-vulnerability-scan: done");
    return new Response(
      JSON.stringify({ ok: true, issues_count: issues.length }),
      { headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  } catch (e) {
    console.log("run-vulnerability-scan: exception", e);
    return new Response(
      JSON.stringify({ error: String(e) }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
