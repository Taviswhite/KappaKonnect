-- Store vulnerability scan results from scanner (HTTP server or Edge Function).
-- Admin panel shows the latest scan in "System & upcoming issues".
CREATE TABLE IF NOT EXISTS public.vulnerability_scan_results (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at timestamptz DEFAULT now() NOT NULL,
  target text,
  summary jsonb,
  issues jsonb NOT NULL DEFAULT '[]'::jsonb
);

COMMENT ON TABLE public.vulnerability_scan_results IS 'Results from vulnerability scanner; each row is one scan. issues = array of { id, title, detail, severity }';

CREATE INDEX IF NOT EXISTS idx_vulnerability_scan_results_created_at ON public.vulnerability_scan_results(created_at DESC);

ALTER TABLE public.vulnerability_scan_results ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Admins and e_board can read vulnerability_scan_results"
  ON public.vulnerability_scan_results FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM public.user_roles ur
      WHERE ur.user_id = auth.uid() AND ur.role IN ('admin', 'e_board')
    )
  );

CREATE POLICY "Service role can insert vulnerability_scan_results"
  ON public.vulnerability_scan_results FOR INSERT
  TO service_role
  WITH CHECK (true);
